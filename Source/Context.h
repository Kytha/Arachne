#pragma once

#include <emmintrin.h>
#include <inttypes.h>

#pragma section(".text")

__declspec(allocate(".text"))
static unsigned char switchContextCode[] = {
  0x48, 0x8d, 0x05, 0xfd, 0x00, 0x00, 0x00,
  0x50,
  0x48, 0x89, 0x19,
  0x48, 0x89, 0x61, 0x08,
  0x48, 0x89, 0x69, 0x10,
  0x4c, 0x89, 0x61, 0x18,
  0x4c, 0x89, 0x69, 0x20,
  0x4c, 0x89, 0x71, 0x28,
  0x4c, 0x89, 0x79, 0x30,
  0x48, 0x89, 0x79, 0x38,
  0x48, 0x89, 0x71, 0x40,
  0x0f, 0xae, 0x59, 0x48,
  0x9b, 0xd9, 0x79, 0x4c,
  0x66, 0x0f, 0x7f, 0x71, 0x50,
  0x66, 0x0f, 0x7f, 0x79, 0x60,
  0x66, 0x44, 0x0f, 0x7f, 0x41, 0x70,
  0x66, 0x44, 0x0f, 0x7f, 0x89, 0x80, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0x91, 0x90, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0x99, 0xa0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0xa1, 0xb0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0xa9, 0xc0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0xb1, 0xd0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x7f, 0xb9, 0xe0, 0x00, 0x00, 0x00,
  0x48, 0x8b, 0x1a,
  0x48, 0x8b, 0x62, 0x08,
  0x48, 0x8b, 0x6a, 0x10,
  0x4c, 0x8b, 0x62, 0x18,
  0x4c, 0x8b, 0x6a, 0x20,
  0x4c, 0x8b, 0x72, 0x28,
  0x4c, 0x8b, 0x7a, 0x30,
  0x48, 0x8b, 0x7a, 0x38,
  0x48, 0x8b, 0x72, 0x40,
  0x0f, 0xae, 0x52, 0x48,
  0xd9, 0x6a, 0x4c,
  0x66, 0x0f, 0x6f, 0x72, 0x50,
  0x66, 0x0f, 0x6f, 0x7a, 0x60,
  0x66, 0x44, 0x0f, 0x6f, 0x42, 0x70,
  0x66, 0x44, 0x0f, 0x6f, 0x8a, 0x80, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0x92, 0x90, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0x9a, 0xa0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0xa2, 0xb0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0xaa, 0xc0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0xb2, 0xd0, 0x00, 0x00, 0x00,
  0x66, 0x44, 0x0f, 0x6f, 0xba, 0xe0, 0x00, 0x00, 0x00,
  0x48, 0x89, 0xd1,
  0x4c, 0x89, 0xca,
  0x4c, 0x89, 0xc0,
  0xc3
};

__declspec(allocate(".text"))
static unsigned char exitTaskCode[] = {
  0x00
};

#pragma pack (16)
struct Context {
  uint64_t rbx, rsp, rbp, r12, r13, r14, r15, rdi, rsi;
  uint32_t mxcsr;
  uint16_t fpucw;
  uint16_t __pad0;
  __m128i xmm6, xmm7, xmm8, xmm9, xmm10, xmm11, xmm12, xmm13, xmm14, xmm15;
};

static void (*switchContext)(Context*, Context*, uint64_t, void *) = (void (*)(Context*, Context*, uint64_t, void *))(void *)switchContextCode;

static void (*ExitTask)(void) = (void (*)(void))(void*)exitTaskCode;